{"ast":null,"code":"import { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\n\nvar _jsxFileName = \"/Users/shuowang/ETM/Leekdao/leekdao-farm/src/views/Billboard/Map/BillboardForm.tsx\",\n    _s = $RefreshSig$();\n\nimport React, { useState, useCallback } from 'react';\nimport ipfsClient from 'ipfs-http-client';\nimport styled from 'styled-components';\nimport { getBalanceNumber } from \"utils/formatBalance\";\nimport { Text, Button, Input, Heading, Flex, useModal } from \"leek-uikit\";\nimport { useWallet } from '@binance-chain/bsc-use-wallet';\nimport UnlockButton from 'components/UnlockButton';\nimport { useBillboardApprove } from 'hooks/useApprove';\nimport { getCakeAddress, getBillboardAddress } from 'utils/addressHelpers';\nimport { useERC20, useBillboardContract } from 'hooks/useContract';\nimport { useBillboardAllowance } from 'hooks/useAllowance';\nimport useTokenBalance from 'hooks/useTokenBalance';\nimport BigNumber from 'bignumber.js';\nimport validator from \"validator\";\nimport ConfirmationPendingContent from '../Modal/ConfirmationPendeingContent';\nimport BillboardBidModal from '../Modal/BillboardBidModal';\nimport { GET_BID_BILLBOARD_HASH, HIDE_FORM } from '../store/reducer';\nimport { store, bidStore } from \"../store/store\";\nimport { useGetBaseInfo } from '../api';\nconst ipfs = ipfsClient({\n  host: 'ipfs.infura.io',\n  port: 5001,\n  protocol: 'https'\n});\nconst FormLayout = styled.div`\n    padding:30px;\n\n    @media (max-width: 768px) {\n        padding:20px\n    }\n`;\n_c = FormLayout;\nconst Textarea = styled.textarea`\n    background-color: #eeeaf4;\n    border: 0;\n    border-radius: 16px;\n    box-shadow: inset 0px 2px 2px -1px rgb(74 74 104 / 10%);\n    color: #452A7A;\n    display: block;\n    font-size: 16px;\n    height: 100px;\n    outline: 0;\n    width: 100%;\n    padding:15px;\n`;\n_c2 = Textarea;\n\nconst BillboardForm = ({\n  info,\n  setPopupInfo\n}) => {\n  _s();\n\n  const {\n    id,\n    city,\n    isBid\n  } = info;\n  const {\n    account\n  } = useWallet();\n  const [description, setDescription] = useState(\"\");\n  const [buffer, setBuffer] = useState(null);\n  const [file, setFile] = useState(null);\n  const [validImage, setValidImage] = useState(false);\n  const [validDescription, setValidDescription] = useState(true);\n  const [approval, setApproval] = useState(true);\n  const tokenAddress = getCakeAddress();\n  const baseInfo = useGetBaseInfo();\n  const minimumTokenAmount = baseInfo && baseInfo.minimumTokenAmount;\n  const formatedMinimumTokenAmount = getBalanceNumber(new BigNumber(minimumTokenAmount));\n  const tokenContract = useERC20(tokenAddress);\n  const billboardContract = useBillboardContract();\n  const billboardAddress = getBillboardAddress();\n  const {\n    onApprove\n  } = useBillboardApprove(tokenContract, billboardAddress);\n  const allowance = new BigNumber(useBillboardAllowance(tokenContract, billboardAddress) || 0);\n  const needsApproval = allowance.toNumber() <= 0;\n  console.log(\">>>>>>>>>>>>>\", allowance.toNumber());\n  const tokenBalance = useTokenBalance(tokenAddress);\n  const formatedTokenBalance = getBalanceNumber(tokenBalance);\n  const isQualified = isBid || formatedTokenBalance >= formatedMinimumTokenAmount;\n  const [onPresentConfirmationModal] = useModal( /*#__PURE__*/_jsxDEV(ConfirmationPendingContent, {\n    onDismiss: () => {\n      return null;\n    }\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 83,\n    columnNumber: 51\n  }, this));\n  const [onPresentBillboardBidModal] = useModal( /*#__PURE__*/_jsxDEV(BillboardBidModal, {\n    onDismiss: () => {\n      return null;\n    }\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 84,\n    columnNumber: 51\n  }, this));\n  const handleApprove = useCallback(async () => {\n    try {\n      setApproval(true);\n      const txHash = await onApprove();\n\n      if (!txHash) {\n        setApproval(false);\n      }\n    } catch (e) {\n      console.error(e);\n    }\n  }, [onApprove, setApproval]);\n\n  const validateAllFields = (field, fieldValue) => {\n    if (field === 'description') {\n      setDescription(fieldValue);\n\n      if (validator.isLength(fieldValue, {\n        min: 1,\n        max: 50\n      })) {\n        setValidDescription(true);\n      } else {\n        setValidDescription(false);\n      }\n    }\n\n    if (field === 'image') {\n      const maxAllowedSize = 5 * 1024 * 1024;\n\n      if (Number(fieldValue) > maxAllowedSize) {\n        setValidImage(false);\n      } else {\n        setValidImage(true);\n      }\n    }\n  };\n\n  const handleIsValid = (e, field) => {\n    validateAllFields(field, e);\n  };\n\n  const captureFile = event => {\n    event.preventDefault();\n    const image = event.target.files[0];\n    handleIsValid(image.size, 'image');\n    const urlReader = new window.FileReader();\n    const bufferReader = new window.FileReader();\n    urlReader.readAsDataURL(image);\n    bufferReader.readAsArrayBuffer(image);\n\n    urlReader.onload = arg => {\n      setFile(arg.target.result);\n    };\n\n    bufferReader.onloadend = () => {\n      const arrayBuffer = new Uint8Array(bufferReader.result);\n      setBuffer(Buffer.from(arrayBuffer));\n    };\n  };\n\n  const onSubmit = async event => {\n    event.preventDefault();\n    const response = await ipfs.add(buffer);\n    const {\n      hash\n    } = response[0];\n    onPresentConfirmationModal();\n    const result = await billboardContract.methods.bid(id, city, hash, description).send({\n      from: account\n    });\n\n    if (result) {\n      const action = {\n        type: GET_BID_BILLBOARD_HASH,\n        bidHash: result.transactionHash\n      };\n      store.dispatch(action);\n      onPresentBillboardBidModal();\n    }\n\n    setPopupInfo(null);\n    bidStore.dispatch({\n      type: HIDE_FORM\n    });\n  };\n\n  return /*#__PURE__*/_jsxDEV(FormLayout, {\n    children: [/*#__PURE__*/_jsxDEV(Heading, {\n      color: \"secondary\",\n      size: \"lg\",\n      children: \"Bill Board Bid Form\"\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 161,\n      columnNumber: 13\n    }, this), /*#__PURE__*/_jsxDEV(Text, {\n      children: [\"City: \", info.city]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 162,\n      columnNumber: 13\n    }, this), /*#__PURE__*/_jsxDEV(\"form\", {\n      onSubmit: onSubmit,\n      children: [/*#__PURE__*/_jsxDEV(\"div\", {\n        style: {\n          marginBottom: '10px'\n        },\n        children: [/*#__PURE__*/_jsxDEV(Text, {\n          mb: \"5px\",\n          children: \"* Descriptions:\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 165,\n          columnNumber: 21\n        }, this), /*#__PURE__*/_jsxDEV(Textarea, {\n          placeholder: \"Descriptions...\",\n          name: \"description\",\n          value: description,\n          onChange: e => handleIsValid(e.currentTarget.value, \"description\"),\n          required: true\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 166,\n          columnNumber: 21\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 164,\n        columnNumber: 17\n      }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n        style: {\n          marginBottom: '10px'\n        },\n        children: [/*#__PURE__*/_jsxDEV(Text, {\n          mb: \"5px\",\n          children: \"* Upload Images:\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 176,\n          columnNumber: 21\n        }, this), /*#__PURE__*/_jsxDEV(Input, {\n          type: \"file\",\n          name: \"img\",\n          accept: \"image/*\",\n          onChange: captureFile,\n          required: true,\n          style: {\n            padding: \"8px\"\n          }\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 177,\n          columnNumber: 21\n        }, this), file && /*#__PURE__*/_jsxDEV(\"img\", {\n          src: file,\n          alt: \"board\",\n          width: \"200px\",\n          style: {\n            marginTop: \"10px\"\n          }\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 186,\n          columnNumber: 30\n        }, this), /*#__PURE__*/_jsxDEV(\"br\", {}, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 186,\n          columnNumber: 105\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 175,\n        columnNumber: 17\n      }, this), account && !isQualified && /*#__PURE__*/_jsxDEV(Text, {\n        color: \"failure\",\n        mb: \"10px\",\n        children: [\"* First Time Creation Required: \", formatedMinimumTokenAmount, \" LEEK\"]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 189,\n        columnNumber: 45\n      }, this), account && !validDescription && /*#__PURE__*/_jsxDEV(Text, {\n        color: \"failure\",\n        mb: \"10px\",\n        children: \"* Character size is 1 - 50\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 191,\n        columnNumber: 50\n      }, this), account && !validImage && /*#__PURE__*/_jsxDEV(Text, {\n        color: \"failure\",\n        mb: \"10px\",\n        children: \"* Maximum Image Size is: 5MB\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 193,\n        columnNumber: 44\n      }, this), account ? /*#__PURE__*/_jsxDEV(Flex, {\n        alignItems: \"center\",\n        justifyContent: \"space-between\",\n        children: [/*#__PURE__*/_jsxDEV(Button, {\n          onClick: handleApprove,\n          disabled: !isQualified || !needsApproval || !approval || !validImage || !validDescription,\n          children: \"Approve\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 196,\n          columnNumber: 21\n        }, this), /*#__PURE__*/_jsxDEV(Button, {\n          type: \"submit\",\n          disabled: !isQualified || needsApproval || !validImage || !validDescription,\n          children: \"Submit\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 197,\n          columnNumber: 21\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 195,\n        columnNumber: 28\n      }, this) : /*#__PURE__*/_jsxDEV(UnlockButton, {}, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 198,\n        columnNumber: 27\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 163,\n      columnNumber: 13\n    }, this)]\n  }, void 0, true, {\n    fileName: _jsxFileName,\n    lineNumber: 160,\n    columnNumber: 9\n  }, this);\n};\n\n_s(BillboardForm, \"fV7ZMTdsptLswbqJRqi8WCEu2l8=\", false, function () {\n  return [useWallet, useGetBaseInfo, useERC20, useBillboardContract, useBillboardApprove, useBillboardAllowance, useTokenBalance, useModal, useModal];\n});\n\n_c3 = BillboardForm;\nexport default _c4 = /*#__PURE__*/React.memo(BillboardForm);\n\nvar _c, _c2, _c3, _c4;\n\n$RefreshReg$(_c, \"FormLayout\");\n$RefreshReg$(_c2, \"Textarea\");\n$RefreshReg$(_c3, \"BillboardForm\");\n$RefreshReg$(_c4, \"%default%\");","map":{"version":3,"sources":["/Users/shuowang/ETM/Leekdao/leekdao-farm/src/views/Billboard/Map/BillboardForm.tsx"],"names":["React","useState","useCallback","ipfsClient","styled","getBalanceNumber","Text","Button","Input","Heading","Flex","useModal","useWallet","UnlockButton","useBillboardApprove","getCakeAddress","getBillboardAddress","useERC20","useBillboardContract","useBillboardAllowance","useTokenBalance","BigNumber","validator","ConfirmationPendingContent","BillboardBidModal","GET_BID_BILLBOARD_HASH","HIDE_FORM","store","bidStore","useGetBaseInfo","ipfs","host","port","protocol","FormLayout","div","Textarea","textarea","BillboardForm","info","setPopupInfo","id","city","isBid","account","description","setDescription","buffer","setBuffer","file","setFile","validImage","setValidImage","validDescription","setValidDescription","approval","setApproval","tokenAddress","baseInfo","minimumTokenAmount","formatedMinimumTokenAmount","tokenContract","billboardContract","billboardAddress","onApprove","allowance","needsApproval","toNumber","console","log","tokenBalance","formatedTokenBalance","isQualified","onPresentConfirmationModal","onPresentBillboardBidModal","handleApprove","txHash","e","error","validateAllFields","field","fieldValue","isLength","min","max","maxAllowedSize","Number","handleIsValid","captureFile","event","preventDefault","image","target","files","size","urlReader","window","FileReader","bufferReader","readAsDataURL","readAsArrayBuffer","onload","arg","result","onloadend","arrayBuffer","Uint8Array","Buffer","from","onSubmit","response","add","hash","methods","bid","send","action","type","bidHash","transactionHash","dispatch","marginBottom","currentTarget","value","padding","marginTop","memo"],"mappings":"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","sourcesContent":["import React, { useState, useCallback } from 'react';\nimport ipfsClient from 'ipfs-http-client'\nimport styled from 'styled-components';\nimport { City } from \"config/constants/types\"\nimport { getBalanceNumber } from \"utils/formatBalance\"\nimport { Text, Button, Input, Heading, Flex, useModal } from \"leek-uikit\"\nimport { useWallet } from '@binance-chain/bsc-use-wallet'\nimport UnlockButton from 'components/UnlockButton';\nimport { useBillboardApprove } from 'hooks/useApprove';\nimport { getCakeAddress, getBillboardAddress } from 'utils/addressHelpers';\nimport { useERC20, useBillboardContract } from 'hooks/useContract';\nimport { useBillboardAllowance } from 'hooks/useAllowance';\nimport useTokenBalance from 'hooks/useTokenBalance';\nimport BigNumber from 'bignumber.js';\nimport validator from \"validator\"\nimport ConfirmationPendingContent from '../Modal/ConfirmationPendeingContent';\nimport BillboardBidModal from '../Modal/BillboardBidModal';\nimport { GET_BID_BILLBOARD_HASH, HIDE_FORM } from '../store/reducer';\nimport { store, bidStore } from \"../store/store\"\nimport { useGetBaseInfo } from '../api';\n\nconst ipfs = ipfsClient({ host: 'ipfs.infura.io', port: 5001, protocol: 'https' })\n\ninterface Info extends City {\n    desc?: string\n    isBid?: boolean,\n    owner?: string,\n    ipfsHash?: string,\n    bidLevel?: number\n\n}\n\ninterface formPorps {\n    info: Info\n    setPopupInfo: (params) => void\n}\n\nconst FormLayout = styled.div`\n    padding:30px;\n\n    @media (max-width: 768px) {\n        padding:20px\n    }\n`\n\nconst Textarea = styled.textarea`\n    background-color: #eeeaf4;\n    border: 0;\n    border-radius: 16px;\n    box-shadow: inset 0px 2px 2px -1px rgb(74 74 104 / 10%);\n    color: #452A7A;\n    display: block;\n    font-size: 16px;\n    height: 100px;\n    outline: 0;\n    width: 100%;\n    padding:15px;\n`\n\nconst BillboardForm: React.FC<formPorps> = ({ info, setPopupInfo }) => {\n    const { id, city, isBid } = info;\n    const { account } = useWallet()\n    const [description, setDescription] = useState(\"\")\n    const [buffer, setBuffer] = useState(null);\n    const [file, setFile] = useState(null);\n    const [validImage, setValidImage] = useState(false)\n    const [validDescription, setValidDescription] = useState(true)\n    const [approval, setApproval] = useState(true)\n    const tokenAddress = getCakeAddress()\n    const baseInfo = useGetBaseInfo()\n    const minimumTokenAmount = baseInfo && baseInfo.minimumTokenAmount\n    const formatedMinimumTokenAmount = getBalanceNumber(new BigNumber(minimumTokenAmount))\n    const tokenContract = useERC20(tokenAddress);\n    const billboardContract = useBillboardContract()\n    const billboardAddress = getBillboardAddress()\n    const { onApprove } = useBillboardApprove(tokenContract, billboardAddress)\n    const allowance = new BigNumber(useBillboardAllowance(tokenContract, billboardAddress) || 0)\n    const needsApproval = allowance.toNumber() <= 0\n    console.log(\">>>>>>>>>>>>>\", allowance.toNumber())\n    const tokenBalance = useTokenBalance(tokenAddress)\n    const formatedTokenBalance = getBalanceNumber(tokenBalance)\n    const isQualified = isBid || formatedTokenBalance >= formatedMinimumTokenAmount\n    const [onPresentConfirmationModal] = useModal(<ConfirmationPendingContent onDismiss={() => { return null }} />)\n    const [onPresentBillboardBidModal] = useModal(<BillboardBidModal onDismiss={() => { return null }} />)\n\n    const handleApprove = useCallback(async () => {\n        try {\n            setApproval(true)\n            const txHash = await onApprove()\n            if (!txHash) {\n                setApproval(false)\n            }\n        } catch (e) {\n            console.error(e)\n        }\n    }, [onApprove, setApproval])\n\n    const validateAllFields = (field: string, fieldValue: string) => {\n        if (field === 'description') {\n            setDescription(fieldValue)\n            if (validator.isLength(fieldValue, { min: 1, max: 50 })) {\n                setValidDescription(true)\n            } else {\n                setValidDescription(false)\n            }\n        }\n\n        if (field === 'image') {\n            const maxAllowedSize = 5 * 1024 * 1024;\n            if (Number(fieldValue) > maxAllowedSize) {\n                setValidImage(false)\n            } else {\n                setValidImage(true)\n            }\n        }\n    }\n\n    const handleIsValid = (e, field: string) => {\n        validateAllFields(field, e);\n    }\n\n    const captureFile = (event) => {\n        event.preventDefault()\n        const image = event.target.files[0]\n        handleIsValid(image.size, 'image')\n        const urlReader = new window.FileReader()\n        const bufferReader = new window.FileReader()\n        urlReader.readAsDataURL(image)\n        bufferReader.readAsArrayBuffer(image)\n\n        urlReader.onload = (arg) => {\n            setFile(arg.target.result)\n        }\n\n        bufferReader.onloadend = () => {\n            const arrayBuffer = new Uint8Array(bufferReader.result as ArrayBuffer)\n            setBuffer(Buffer.from(arrayBuffer));\n        }\n    }\n\n    const onSubmit = async (event) => {\n        event.preventDefault()\n        const response = await ipfs.add(buffer);\n        const { hash } = response[0];\n        onPresentConfirmationModal();\n        const result = await billboardContract.methods.bid(id, city, hash, description).send({ from: account })\n        if (result) {\n            const action = {\n                type: GET_BID_BILLBOARD_HASH,\n                bidHash: result.transactionHash,\n            }\n            store.dispatch(action)\n            onPresentBillboardBidModal()\n        }\n        setPopupInfo(null);\n        bidStore.dispatch({ type: HIDE_FORM })\n    }\n\n    return (\n        <FormLayout>\n            <Heading color=\"secondary\" size=\"lg\">Bill Board Bid Form</Heading>\n            <Text>City: {info.city}</Text>\n            <form onSubmit={onSubmit}>\n                <div style={{ marginBottom: '10px' }}>\n                    <Text mb=\"5px\">* Descriptions:</Text>\n                    <Textarea\n                        placeholder=\"Descriptions...\"\n                        name=\"description\"\n                        value={description}\n                        onChange={(e) => handleIsValid(e.currentTarget.value, \"description\")}\n                        required\n                    />\n                </div>\n\n                <div style={{ marginBottom: '10px' }}>\n                    <Text mb=\"5px\">* Upload Images:</Text>\n                    <Input\n                        type=\"file\"\n                        name=\"img\"\n                        accept=\"image/*\"\n                        onChange={captureFile}\n                        required\n                        style={{ padding: \"8px\" }}\n                    />\n\n                    {file && <img src={file} alt=\"board\" width=\"200px\" style={{ marginTop: \"10px\" }} />}<br />\n                </div>\n\n                {account && !isQualified && <Text color=\"failure\" mb=\"10px\">* First Time Creation Required: {formatedMinimumTokenAmount} LEEK</Text>}\n\n                {account && !validDescription && <Text color=\"failure\" mb=\"10px\">* Character size is 1 - 50</Text>}\n\n                {account && !validImage && <Text color=\"failure\" mb=\"10px\">* Maximum Image Size is: 5MB</Text>}\n\n                {account ? <Flex alignItems=\"center\" justifyContent=\"space-between\">\n                    <Button onClick={handleApprove} disabled={!isQualified || !needsApproval || !approval || !validImage || !validDescription}>Approve</Button>\n                    <Button type=\"submit\" disabled={!isQualified || needsApproval || !validImage || !validDescription}>Submit</Button>\n                </Flex> : <UnlockButton />}\n\n\n            </form>\n        </FormLayout>\n\n    )\n}\n\nexport default React.memo(BillboardForm);"]},"metadata":{},"sourceType":"module"}